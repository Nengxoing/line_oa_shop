<div class="p-2" style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem;">
    {% for data in products_data %}
    <div class="col d-flex justify-content-between flex-column gap-2 p-1 border rounded shadow-sm bg-white">
        <div>
            {% if data.url_image == None %}
            <img class="product-img" src="/static/odm.png" alt="img"
                style="width: 100%; height: auto; object-fit: cover;">
            {% else %}
            <img class="product-img" src="/static/image/product/{{data.url_image}}" alt="img"
                style="width: 100%; height: auto; object-fit: cover;">
            {% endif %}

            <p hidden class="name-code" style="font-size: 14px;">{{ data['code'] }}</p>
            <p class="name-market" style="font-size: 14px;">{{ data['name_market'] }}</p>
            <p class="sale-price text-danger fw-medium mt-1"><b class="sale_price">{{"{:,}".format(data.sale_price)
                    }}</b> KIP</p>
            <p class="regular-price" style="font-size: 14px;"><s id="regular_price">{{"{:,}".format(data.regular_price)
                    }}</s> KIP</p>
        </div>
        <!-- <button onclick="addToCard(this)" data-bs-toggle="modal" data-bs-target="#selectQty" class="btn w-100 text-white fw-medium" style="background-color: var(--second-color);">ເພີ່ມເຂົ້າກະຕ່າ</button> -->
        <button data-bs-toggle="modal" data-bs-target="#selectQty" class="btn w-100 text-white fw-medium"
            style="background-color: var(--second-color);">ເພີ່ມເຂົ້າກະຕ່າ</button>
    </div>
    {% endfor %}
</div>

<script>
    window.onload = function () {
        updateCartUI();
    };

    function addToCard(button) {
        const card = button.closest(".col");
        const productImage = card.querySelector(".product-img").src;
        const marketCode = card.querySelector(".name-code").innerText;
        const nameMarket = card.querySelector(".name-market").innerText;
        const salePrice = card.querySelector(".sale_price").innerText;
        const imageName = productImage.split("/").pop();

        const data = {
            code: marketCode,
            name: nameMarket,
            sale_price: salePrice,
            image: imageName
        };

        fetch("/addToCard", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify(data)
        })
            .then(response => response.json())
            .then(result => {
                console.log("✅ Server Response:", result);
                if (result.status === "success") {
                    updateCartUI();

                    Swal.fire({
                        icon: 'success',
                        title: 'ສຳເລັດ',
                        text: 'ເພິ່ມສິນຄ້າລົງໃນກະຕ່າແລ້ວ!',
                        showConfirmButton: false,
                        timer: 3000
                    })
                }
            })
            .catch(error => console.error("❌ Error:", error));
    }

    function updateCartUI() {
        fetch("/getAddToCard")
            .then(response => response.json())
            .then(result => {
                if (result.status === "success") {
                    const modalBody = document.querySelector(".product-card");
                    modalBody.innerHTML = "";

                    let totalPrice = 0;

                    if (result.cart.length === 0) {
                        modalBody.innerHTML = `<p class="text-center text-muted">ທ່ານຍັງບໍ່ໄດ້ເລືອກສິນຄ້າ!</p>`;
                        return;
                    }

                    result.cart.forEach(item => {
                        const qty = item.qty || 1;
                        totalPrice += parseFloat(item.sale_price.replace(/,/g, '')) * qty;

                        const imageUrl = item.image && item.image.trim() !== ""
                            ? `/static/image/product/${item.image}`
                            : `/static/odm.png`;

                        const cartItemHTML = `
                        <div class="bg-white border shadow-sm rounded overflow-hidden" style="display: grid; grid-template-columns: 30% 1fr; height: 110px; position: relative;">
                            <img class="border-end" src="${imageUrl}" alt="" 
                                onerror="this.onerror=null; this.src='/static/odm.png'; this.style.width='100%'; this.style.height='100%'; this.style.objectFit='cover';"
                                style="width: 100%; height: 100%; object-fit: cover;">
                            <div class="py-2 px-2 d-flex flex-column justify-content-between">
                                <p class="market-name" style="margin-right: 5px;">${item.name}</p>
                                <div class="d-flex justify-content-between align-items-end">
                                    <p class="text-danger mb-0 text-start"><b>${item.sale_price} KIP</b></p>
                                    <p style="font-size: 14px; color: #666;">ຈຳນວນ: <span class="qty">${qty}</span></p>
                                </div>
                            </div>
                            <button class="text-danger delete-btn" data-code="${item.market_code}" style="background-color: transparent; border: none; outline: none; position: absolute; right: 4px; top: 1px;">
                                <i class="bi bi-x-square-fill"></i>
                            </button>
                        </div>
                    `;

                        modalBody.insertAdjacentHTML("beforeend", cartItemHTML);
                    });

                    addDeleteEvents(); // ลบสินค้าได้
                }
            })
            .catch(error => console.error("❌ Error fetching cart data:", error));
    }

    function addDeleteEvents() {
        document.querySelectorAll(".delete-btn").forEach(button => {
            button.addEventListener("click", function () {
                const code = this.getAttribute("data-code");
                deleteCard(code); // เรียกไปลบฝั่ง backend
            });
        });
    }

    function deleteCard(code) {
        fetch("/deleteCard", {
            method: "POST",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({ code: code })
        })
            .then(response => response.json())
            .then(() => {
                updateCartUI(); // อัปเดตรายการสินค้าใหม่หลังลบ
            })
            .catch(error => console.error("❌ Error deleting card item:", error));
    }
</script>