{% extends "layout/layout.html" %} {% block title %}ລາຍການສິນຄ້າໃນກະຕ່າ{% endblock %} {% block head %}
<!-- templates\line_oa\line_os_shop\layouts\layout.html -->
<style>
    i.fa.fa-shopping-cart,
    #footer-bar a.cart span {
        color: #EB6703 !important;
    }

    #customers {
        font-family: "phetsarath ot";
        border-collapse: collapse;
        width: 100%;
    }

    #customers td,
    #customers th {
        border: 1px solid #ddd;
        padding: 8px;
    }

    /* #customers tr:nth-child(even) {
        background-color: #f2f2f2;
    } */
    /* #customers tr:hover {
        background-color: #ddd;
    } */

    #customers th {
        padding-top: 12px;
        padding-bottom: 12px;
        text-align: left;
        background-color: #0162bd;
        color: white;
    }

    .button1 {
        background-color: #2E6FB6;
        /* Green */
        border: none;
        color: white;
        padding: 5px 5px;
        text-align: center;
        text-decoration: none;
        display: block;
        font-size: 16px;
        height: 30px;
        width: 100%;
        border-radius: 5px;
    }

    .button1:hover {
        background-color: #0ca8f0;
        color: white;
    }

    h5 {
        font-family: "phetsarath ot";
        font-size: 12px;
    }

    ul.a {
        list-style-type: circle;
    }

    p {
        font-family: 'phetsarath ot';
    }

    li {
        font-family: 'phetsarath ot';
    }

    hr.new4 {
        border: 1px solid red;
        /* width:50%; */
        text-align: center;
        margin-top: 10px;
        margin-bottom: 10px;
    }

    /* #navbar_bbb {
        position: fixed !important;
        left: 0 !important;
        right: 0 !important;
        z-index: 10 !important;
    } */

    header.header,
    #padding-bt {
        display: none !important;
    }
</style>
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/homepage.css') }}">
<link rel="stylesheet" type="text/css" href="{{ url_for('static',filename='styles/shopping_cart.css') }}">
<link rel="stylesheet" href="https://developers.google.com//maps/documentation/javascript/demos/demos.css">
<style>
    #map {
        height: 100%;
        width: 100%;
    }

    div#footer-bar.footer-bar-1 {
        display: none !important;
    }

    .awesome {
        width: 100%;
        margin: 0 auto;
        text-align: center;
        color: #313131;
        font-weight: bold;
        -webkit-animation: colorchange 20s infinite alternate;
    }

    @-webkit-keyframes colorchange {
        0% {
            color: blue;
        }

        10% {
            color: #8e44ad;
        }

        20% {
            color: #1abc9c;
        }

        30% {
            color: #d35400;
        }

        40% {
            color: blue;
        }

        50% {
            color: #34495e;
        }

        60% {
            color: blue;
        }

        70% {
            color: #2980b9;
        }

        80% {
            color: #f1c40f;
        }

        90% {
            color: #2980b9;
        }

        100% {
            color: pink;
        }
    }
</style>
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.27.3.js"></script>
<script src="/static/js/onepay.js"></script>
<script>
    $(function () {
        var mcid = "mch667bdd4aaf07a"; // merchant id
        var shopcode = "tCpJN9pvOwYD"; // shop code
        // var uuid = '{{bill_h.doc_no}}'; // transaction id (please define as unique key)
        const uuid = currentPath.split('/').pop();
        var onePay = new OnePay(mcid); // create new OnePay instance
        onePay.debug = true; // enable OnPay debug(Please looking on console log)

        console.log("uuid:", uuid)
        console.log("amount raw: ", '{{ total_amount }}');
        
        onePay.getCode({
            transactionid: uuid,
            invoiceid: uuid,
            terminalid: '001',
            // amount: '{{total_amount}}',
            amount: "1",
            description: 'Odienmall_Order:' + uuid,
            expiretime: 5,
        }, function (code) {
            $('.qr-code').attr('src', 'https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=' + code);
            $('.one-click-pay').attr('href', 'onepay://qr/' + code)
        });

        /* define subscribe parameter(s) */
        var subParams = {
            uuid: uuid, // please specified uuid if would like to receive callback data only the transaction (for front-end subscribe)
            shopcode: null, // please specified shopcode if would link to receive all callback for the merchant ID (for back-end subscribe)
            tid: null // please specified tid(terminal ID) and shopcode if would link to receive all callback for the merchant ID and specific terminal (for terminal subscribe)
        };
        /* subscribe to receiving OnePay callback*/
        onePay.subscribe(subParams, function (res) {
            if (res.uuid === uuid) {
                document.getElementById("qrcode").style.display = "none";
                var s = document.getElementById("success");
                s.style.width = "200px";
                s.style.height = "200px";
                const myTimeout = setTimeout(myGreeting, 5000);

                function myGreeting() {
                    window.location.href = '/thankyoupage/{{bill_h.doc_no}}';
                }
            }
        });
    })
</script>

<style>
    .qr-code {
        border: 3px solid #bb1111;
        border-radius: 5px;
    }
</style>
{{ super() }} {% endblock %} {% block content %}
<div class="main-wrapper">
    <div class="">
        <div class="card" id="navbar_bbb">
            <div class="card-header" style="background-color: #C0202F !important;">
                <center>
                    <h5 style="text-transform: none;color: #fff !important;">ສະແກນ OR Code</h5>
                </center>
            </div>
        </div>
        <center><br>
            <div class="center-screen">
                <span style="color:#fff;text-align: center;text-transform: none; " class="mb-4">
                    <h4 style="margin-bottom: 3rem;" class="awesome">
                        <?xml version="1.0" encoding="utf-8"?>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 26 26" width="18" height="18">
                            <path
                                d="M25.289063 20.132813L15.234375 2.71875C14.003906 0.589844 11.996094 0.589844 10.765625 2.71875L0.710938 20.132813C-0.519531 22.261719 0.488281 24 2.945313 24L23.054688 24C25.511719 24 26.515625 22.261719 25.289063 20.132813 Z M 11.617188 7.660156C11.980469 7.269531 12.4375 7.074219 13 7.074219C13.5625 7.074219 14.019531 7.265625 14.382813 7.652344C14.738281 8.035156 14.921875 8.519531 14.921875 9.101563C14.921875 9.597656 14.171875 13.269531 13.921875 15.9375L12.113281 15.9375C11.894531 13.269531 11.078125 9.597656 11.078125 9.101563C11.078125 8.527344 11.261719 8.046875 11.617188 7.660156 Z M 14.355469 20.355469C13.976563 20.722656 13.523438 20.910156 13 20.910156C12.476563 20.910156 12.023438 20.722656 11.644531 20.355469C11.265625 19.984375 11.078125 19.539063 11.078125 19.011719C11.078125 18.488281 11.265625 18.035156 11.644531 17.65625C12.023438 17.277344 12.476563 17.089844 13 17.089844C13.523438 17.089844 13.976563 17.277344 14.355469 17.65625C14.734375 18.035156 14.921875 18.488281 14.921875 19.011719C14.921875 19.539063 14.734375 19.984375 14.355469 20.355469Z"
                                fill="#F7B803" />
                        </svg>&nbsp; ກຳລັງລໍຖ້າການຊຳລະ
                    </h4>

                    <!-- <h5 style="color:#fff;text-align: center;text-transform: none;color: #000 !important;" class="mb-1">ເລກທີສັ່ງຊື້: {{bill_h.doc_no}}</h5> -->
                    <p id="docNoDisplay" style="color:#000; font-size: 18px; text-align: center; text-transform: none;"
                        class="mb-4 mt-4 fw-bold">
                        ເລກທີສັ່ງຊື້:
                    </p>

                    <!-- <h5 style="color:#fff;text-align: center;text-transform: none;color: #C0202F;" class="mb-2">₭
                        {{sum_total}}</h5>
                    <br> -->

                    <h3
                        style="color:#fff; text-align: center; text-transform: none; color: #C0202F; margin-bottom: 5rem;">
                        ₭ {{total_amount_format}}
                    </h3>

                    <h3 class="mb-1">ODIEN MALL ONLINE</h3>

                    <!-- <h6 style="text-transform: none;">
                    <img src="/static/bcel.png" alt="" style="width: 25px;"> OnePay
                </h6> -->
                    <img id="success" src="https://www.freeiconspng.com/uploads/success-icon-10.png"
                        style="width: 1px; height: 1px" />
                    <div id="qrcode">
                        <img class="qr-codetest" style="width: 20%;" src="/static/app_bcel.png">
                    </div>
                    <br>



                    <h5 class="mt-2" style="color: #000 !important;">ເຫຼືອເວລາ: <span id="ten-countdown">

                        </span></h5>
                    <br>
                    <h6>ກົດປຸມດ້ານລຸ່ມ ເພື່ອຊຳລະເງິນຜ່ານ BCEL One</h6>

                    <br>
                    <!-- <p>(ກະລຸນາເປີດໜ້ານີ້ຄ້າງໄວ້ ຈົນກວ່າ <span style="font-weight: bold;">ຊຳລະເງິນສຳເລັດ</span>)</p> -->
            </div>

        </center>

    </div>
</div>

<div class="card fixed-bottom">
    <div class="card-body" style="background-color: #bb1111 !important">
        <div class=" row ">
            <div class="col p-2">
                <h5 class="text-center align-self-center" style="color: #fff !important; ">
                    <a class="one-click-pay" style="color: #fff !important;">ຊຳລະຜ່ານ BCEL One
                        <?xml version="1.0" encoding="utf-8"?>
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="18" height="18">
                            <path d="M8 3L14 12L8 21L12 21L18 12L12 3L8 3 z" fill="#FFFFFF" />
                        </svg>
                </h5>
            </div>
        </div>
    </div>
    <hr style="margin-bottom: 0%;margin-top: 0% ">
</div>
<script>
    // ดึง path เช่น /paymentpage_mb/ODG28042025
    const currentPath = window.location.pathname;
    const docNo = currentPath.split('/').pop(); // เอาแค่ ODG28042025

    // เอา docNo ไปใส่ใน h5 id="docNoDisplay"
    const docNoDisplay = document.getElementById("docNoDisplay");
    if (docNoDisplay) {
        docNoDisplay.textContent = `ເລກທີສັ່ງຊື້: ${docNo}`;
    }

    function countdown(elementName, minutes, seconds) {
        var element, endTime, hours, mins, msLeft, time;

        function twoDigits(n) {
            return (n <= 9 ? "0" + n : n);
        }

        function updateTimer() {
            msLeft = endTime - (+new Date);
            if (msLeft < 1000) {
                element.innerHTML = "<p>QR ນີ້ໄດ້ໜົດອາຍຸການຊຳລະແລ້ວ</p>";
            } else {
                time = new Date(msLeft);
                hours = time.getUTCHours();
                mins = time.getUTCMinutes();
                element.innerHTML = (hours ? hours + ':' + twoDigits(mins) : mins) + ':' + twoDigits(time.getUTCSeconds());
                setTimeout(updateTimer, time.getUTCMilliseconds() + 500);
            }
        }

        element = document.getElementById(elementName);
        endTime = (+new Date) + 1000 * (60 * minutes + seconds) + 500;
        updateTimer();
    }

    countdown("ten-countdown", 5, 0); 
</script>
<!-- alerts -->
{% with messages = get_flashed_messages() %} {% if messages %} {% for message in messages %} {% if message ==
'ເພີ່ມເຂົ້າກະຕ່າສຳເລັດ' or message == 'ເເກ້ໄຂສຳເລັດ' or message == 'ລົບສຳເລັດ' %}
<script>
    Swal.fire({
        position: 'bottom-center',
        icon: 'success',
        title: '{{message}}',
        showConfirmButton: false,
        timer: 1500
    })
</script>
{% else %}
<script>
    Swal.fire({
        icon: 'error',
        title: '{{message}}',
        text: 'ກະລຸນາລອງໃໝ່ອີກຄັ້ງ',
        confirmButtonText: 'ຕົກລົງ',
    })
</script>
{% endif %} {% endfor %} {% endif %} {% endwith %}
<script></script>
{% endblock %}